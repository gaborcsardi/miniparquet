#! /usr/bin/env sh

# Check that this is not just ./configure. We need to run this
# from R CMD INSTALL, to have the R env vars set.

if [ -z "$R_HOME" ]; then
    echo >&2 R_HOME is not set, are you running R CMD INSTALL?
    exit 1
fi

# Find the R binary we need to use. This is a bit trickier on
# Windows, because it has two architectures. On windows R_ARCH_BIN
# is set, so this should work everywhere.
RBIN="${R_HOME}/bin${R_ARCH_BIN}/R"

RVER=`"$RBIN" --vanilla --slave -e "cat(paste(getRversion()[,1:2]))"`

XXMFIX=""
if [ "$R_OSTYPE" = "windows" ]; then
   if [ "$RVER" = "4.1" ] || [ "$RVER" = "4.0" ]; then
      XXMFIX="-ffixed-xmm16 -ffixed-xmm17 -ffixed-xmm18 -ffixed-xmm19 -ffixed-xmm20 -ffixed-xmm21 -ffixed-xmm22 -ffixed-xmm23 -ffixed-xmm24 -ffixed-xmm25 -ffixed-xmm26 -ffixed-xmm27 -ffixed-xmm28 -ffixed-xmm29 -ffixed-xmm30 -ffixed-xmm31"
   fi
fi

cat src/Makevars.in | \
    sed "s|@XXMFIX@|${XXMFIX}|" > src/Makevars
